name: AI Code Review for Idempotency

on:
  pull_request:
  push:
    branches:
      - main

jobs:
  review:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v2

    - name: Install jq
      run: sudo apt-get install -y jq

    - name: Read and send code file directly
      run: |
        CODE_CONTENT=$(jq -Rs . < src/index.js)
        echo "Escaped code content: $CODE_CONTENT"
        
        JSON_PAYLOAD=$(jq -n --arg code "$CODE_CONTENT" '{
          "model": "gpt-3.5-turbo",
          "prompt": "Please check the following code for idempotency issues: \($code)",
          "max_tokens": 1000
        }')
        
        echo "Sending JSON Payload: $JSON_PAYLOAD"
        curl -X POST https://api.openai.com/v1/completions \
        -H "Content-Type: application/json" \
        -H "Authorization: Bearer ${{ secrets.OPENAI_API_KEY }}" \
        -d "$JSON_PAYLOAD"
